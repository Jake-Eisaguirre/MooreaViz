---
title: "mooreaviz"
author: "Jake Eisaguirre"
date: "1/18/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(here)
library(tidyverse)
library(janitor)
library(raster)
library(viridis)
library(sf)
library(gstat)
library(sp)
library(leaflet)
library(automap)
library(shiny)
library(testthat)
library(htmlwidgets)
library(ggvoronoi)
library(car)
library(dismo)

```

# read in data
```{r}
#nitrogren data
n_data <- read_csv(here("data", "csv", "N_summary_2016.csv")) %>% 
  clean_names()

#bleaching data
bleach <- read_csv(here("data", "csv", "percent_bleach_2016.csv")) %>% 
  clean_names()

#10x10 grid for kriging
grd_sp <- readRDS(here("data", "krig_grid", "grd_sp"))

#moorea crs EPSG:2976
crs <- 2976
```

# Tidy format nitrogen data
```{r}

n_data <- n_data %>% 
  pivot_longer(!1:5, names_to = "type", values_to = "percent_n") %>% 
  separate(type, into = c("method","random", "date"), sep = "_") %>% 
  dplyr::select(-random)

```



# Kriging january nitrogen data for Moorea lagoon/reef boundary
```{r}
# selecting n-jan data
jan_np_data <- n_data %>% 
  filter(date == "jan", method == "percent") %>%
  dplyr::select(longitude, latitude, percent_n) %>% 
  na.omit()


#converting jan data to sf and changing lat long to UTM
sf_jan_np_data <- st_as_sf(jan_np_data, coords = c('longitude', 'latitude'), crs = 4326) %>% 
  cbind(st_coordinates(.)) %>% 
  mutate(geometry = st_transform(geometry, 
                                 "+proj=utm +zone=6 +south +ellps=intl 
                                 +towgs84=162,117,154,0,0,0,0 +units=m +no_defs", 
                                 crs = crs))


#vario gram and model selection 
jan_np_vario <- variogram(percent_n~1, as(sf_jan_np_data, "Spatial"))

plot(jan_np_vario)

v_mod_full_jan <- autofitVariogram(percent_n~1, as(sf_jan_np_data, "Spatial"))

v_mod_jan <- v_mod_full_jan$var_model

plot(v_mod_full_jan)


#krige 
jan_krig_p <- krige(percent_n~1, as(sf_jan_np_data, "Spatial"), 
                  grd_sp, model = v_mod_jan)

#convert kriged data to raster  
jan_ras <- raster(jan_krig_p)


```


# Kriging may nitrogen data for Moorea lagoon/reef boundary
```{r}
# selecting n-may data
may_np_data <- n_data %>% 
  filter(date == "may", method == "percent") %>%
  dplyr::select(longitude, latitude, percent_n) %>% 
  na.omit()


#converting may data to sf and changing lat long to UTM
sf_may_np_data <- st_as_sf(may_np_data, coords = c('longitude', 'latitude'), crs = 4326) %>% 
  cbind(st_coordinates(.)) %>% 
  mutate(geometry = st_transform(geometry, 
                                 "+proj=utm +zone=6 +south +ellps=intl 
                                 +towgs84=162,117,154,0,0,0,0 +units=m +no_defs", 
                                 crs = crs))


#vario gram and model selection 
may_np_vario <- variogram(percent_n~1, as(sf_may_np_data, "Spatial"))

plot(may_np_vario)

v_mod_full_may <- autofitVariogram(percent_n~1, as(sf_may_np_data, "Spatial"))

v_mod_may <- v_mod_full_may$var_model

plot(v_mod_full_may)


#krige 
may_krig_p <- krige(percent_n~1, as(sf_may_np_data, "Spatial"), 
                  grd_sp, model = v_mod_may)

#convert kriged data to raster  
may_ras <- raster(may_krig_p)

plot(may_ras)
```


# Kriging July nitrogen data for Moorea lagoon/reef boundary

```{r}
# selecting n-july data
july_np_data <- n_data %>% 
  filter(date == "july", method == "percent") %>%
  dplyr::select(longitude, latitude, percent_n) %>% 
  na.omit()


#converting july data to sf and changing lat long to UTM
sf_july_np_data <- st_as_sf(july_np_data, coords = c('longitude', 'latitude'), crs = 4326) %>% 
  cbind(st_coordinates(.)) %>% 
  mutate(geometry = st_transform(geometry, 
                                 "+proj=utm +zone=6 +south +ellps=intl 
                                 +towgs84=162,117,154,0,0,0,0 +units=m +no_defs", 
                                 crs = crs))


#vario gram and model selection 
july_np_vario <- variogram(percent_n~1, as(sf_july_np_data, "Spatial"))

plot(july_np_vario)

v_mod_full_july <- autofitVariogram(percent_n~1, as(sf_july_np_data, "Spatial"))

v_mod_july <- v_mod_full_july$var_model

plot(v_mod_full_july)


#krige 
july_krig_p <- krige(percent_n~1, as(sf_july_np_data, "Spatial"), 
                  grd_sp, model = v_mod_july)

#convert kriged data to raster  
july_ras <- raster(july_krig_p)

plot(july_ras)
```

# Kriging january nitrogen isotopic data for Moorea lagoon/reef boundary
```{r}
# selecting n-jan data
jan_ni_data <- n_data %>% 
  filter(date == "jan", method == "d15n") %>%
  dplyr::select(longitude, latitude, percent_n) %>% 
  na.omit()


#converting jan data to sf and changing lat long to UTM
sf_jan_ni_data <- st_as_sf(jan_ni_data, coords = c('longitude', 'latitude'), crs = 4326) %>% 
  cbind(st_coordinates(.)) %>% 
  mutate(geometry = st_transform(geometry, 
                                 "+proj=utm +zone=6 +south +ellps=intl 
                                 +towgs84=162,117,154,0,0,0,0 +units=m +no_defs", 
                                 crs = crs))


#vario gram and model selection 
jan_ni_vario <- variogram(percent_n~1, as(sf_jan_ni_data, "Spatial"))

plot(jan_ni_vario)

v_mod_full_jan_i <- autofitVariogram(percent_n~1, as(sf_jan_ni_data, "Spatial"))

v_mod_jan_i <- v_mod_full_jan_i$var_model

plot(v_mod_full_jan_i)


#krige 
jan_krig_i <- krige(percent_n~1, as(sf_jan_ni_data, "Spatial"), 
                  grd_sp, model = v_mod_jan_i)

#convert kriged data to raster  
jan_ras_i <- raster(jan_krig_i)

plot(jan_ras_i)
```
# Kriging may nitrogen isotopic data for Moorea lagoon/reef boundary
```{r}
# selecting n-may data
may_ni_data <- n_data %>% 
  filter(date == "may", method == "d15n") %>%
  dplyr::select(longitude, latitude, percent_n) %>% 
  na.omit()


#converting may data to sf and changing lat long to UTM
sf_may_ni_data <- st_as_sf(may_ni_data, coords = c('longitude', 'latitude'), crs = 4326) %>% 
  cbind(st_coordinates(.)) %>% 
  mutate(geometry = st_transform(geometry, 
                                 "+proj=utm +zone=6 +south +ellps=intl 
                                 +towgs84=162,117,154,0,0,0,0 +units=m +no_defs", 
                                 crs = crs))


#vario gram and model selection 
may_ni_vario <- variogram(percent_n~1, as(sf_may_ni_data, "Spatial"))

plot(may_ni_vario)

v_mod_full_may_i <- autofitVariogram(percent_n~1, as(sf_may_ni_data, "Spatial"))

v_mod_may_i <- v_mod_full_may_i$var_model

plot(v_mod_full_may_i)


#krige 
may_krig_i <- krige(percent_n~1, as(sf_may_ni_data, "Spatial"), 
                  grd_sp, model = v_mod_may_i)

#convert kriged data to raster  
may_ras_i <- raster(may_krig_i)

plot(may_ras_i)
```


# Kriging july nitrogen isotopic data for Moorea lagoon/reef boundary
```{r}
# selecting n-july data
july_ni_data <- n_data %>% 
  filter(date == "july", method == "d15n") %>%
  dplyr::select(longitude, latitude, percent_n) %>% 
  na.omit()


#converting july data to sf and changing lat long to UTM
sf_july_ni_data <- st_as_sf(july_ni_data, coords = c('longitude', 'latitude'), crs = 4326) %>% 
  cbind(st_coordinates(.)) %>% 
  mutate(geometry = st_transform(geometry, 
                                 "+proj=utm +zone=6 +south +ellps=intl 
                                 +towgs84=162,117,154,0,0,0,0 +units=m +no_defs", 
                                 crs = crs))


#vario gram and model selection 
july_ni_vario <- variogram(percent_n~1, as(sf_july_ni_data, "Spatial"))

plot(july_ni_vario)

v_mod_full_july_i <- autofitVariogram(percent_n~1, as(sf_july_ni_data, "Spatial"))

v_mod_july_i <- v_mod_full_july_i$var_model

plot(v_mod_full_july_i)


#krige 
july_krig_i <- krige(percent_n~1, as(sf_july_ni_data, "Spatial"), 
                  grd_sp, model = v_mod_july_i)

#convert kriged data to raster  
july_ras_i <- raster(july_krig_i)

plot(july_ras_i)
```


# Jakes Box
```{r}

```


# Percent Bleached
```{r}
# #Select column
# bleaching_data <- bleach %>% 
#   dplyr::select(latitude, longitude, percent_bleached) %>% 
#   na.omit()
# 
# #converting bleach data to sf and changing lat long to UTM
# sf_bleached_data <- st_as_sf(bleaching_data, coords = c('longitude', 'latitude'), crs = 4326) %>% 
#   cbind(st_coordinates(.)) %>% 
#   mutate(geometry = st_transform(geometry, 
#                                  "+proj=utm +zone=6 +south +ellps=intl 
#                                  +towgs84=162,117,154,0,0,0,0 +units=m +no_defs", 
#                                  crs = crs))
# 
# #vario gram and model selection 
# bleach_vario <- variogram(percent_bleached~1, as(sf_bleached_data, "Spatial"))
# 
# plot(bleach_vario)
# 
# v_mod_full_bleach <- autofitVariogram(percent_bleached~1, as(sf_bleached_data, "Spatial"))
# 
# v_mod_bleach <- v_mod_full_bleach$var_model
# 
# plot(v_mod_full_bleach)
# 
# july_krig_p <- krige(percent_bleached~1, as(sf_bleached_data, "Spatial"), 
#                   grd_sp, model = "power")

```


# rasters and palettes 
```{r}
# percent nitrogen 
jan_data <- as.data.frame(rasterToPoints(jan_ras))
pal_jan <- colorNumeric(palette = viridis((25), option = "plasma"), domain = jan_data$var1.pred)

may_data <- as.data.frame(rasterToPoints(may_ras))
pal_may <- colorNumeric(palette = viridis((25), option = "plasma"), domain = may_data$var1.pred)

july_data <- as.data.frame(rasterToPoints(july_ras))
pal_july <- colorNumeric(palette = viridis((25), option = "plasma"), domain = july_data$var1.pred)

# isotopic nitrogen 

jan_i_data <- as.data.frame(rasterToPoints(jan_ras_i))
pal_jan_i <- colorNumeric(palette = viridis((25), option = "plasma"), domain = jan_data$var1.pred)

may_i_data <- as.data.frame(rasterToPoints(may_ras_i))
pal_may_i <- colorNumeric(palette = viridis((25), option = "plasma"), domain = may_data$var1.pred)

july_i_data <- as.data.frame(rasterToPoints(july_ras_i))
pal_july_i <- colorNumeric(palette = viridis((25), option = "plasma"), domain = july_data$var1.pred)

```



# leaf for slides
```{r}

leaflet() %>% 
  addProviderTiles("Esri.WorldImagery") %>% 
  addCircleMarkers(lng = jan_np_data$longitude, lat = jan_np_data$latitude,
                   color = "black", group = "Observations") %>% 
  addRasterImage(jan_ras, colors = "plasma", group = "January N", opacity = 0.7) %>% 
  addRasterImage(may_ras, colors = "plasma", group = "May N", opacity = 0.7) %>% 
  addRasterImage(july_ras, colors = "plasma", group = "July N", opacity = 0.7) %>% 
  addRasterImage(jan_ras_i, colors = "plasma", group = "January N Isotopic", opacity = 0.7) %>% 
  addRasterImage(may_ras_i, colors = "plasma", group = "May N Isotopic", opacity = 0.7) %>% 
  addRasterImage(july_ras_i, colors = "plasma", group = "July N Isotopic", opacity = 0.7) %>%
  addLayersControl(
    baseGroups = c("January N", 
                   "May N", 
                   "July N", 
                   "January N Isotopic", 
                   "May N Isotopic", 
                   "July N Isotopic"),
    overlayGroups = c("Observations"),
    options = layersControlOptions(collapsed = FALSE))  %>% 
  addLegend(data = jan_data, title = 'January N', pal = pal_jan,
            position = "bottomright", 
            values = ~var1.pred, opacity = 1, group = "January N") %>% 
  onRender("
    function(el, x) {
      var updateLegend = function () {
          var selectedGroup =       document.querySelectorAll('input:checked')[0].nextSibling.innerText.substr(1);

          document.querySelectorAll('.legend').forEach(a => a.hidden=true);
          document.querySelectorAll('.legend').forEach(l => {
            if (l.children[0].children[0].innerText == selectedGroup) l.hidden=false;
          });
      };
      updateLegend();
      this.on('baselayerchange', e => updateLegend());
    }") %>% 
  addLegend(data = may_data, title = 'May N', pal = pal_may,
            position = "bottomright", 
            values = ~var1.pred, opacity = 1, group = "May N") %>% 
  addLegend(data = may_data, title = 'July N', pal = pal_may,
            position = "bottomright", 
            values = ~var1.pred, opacity = 1, group = "July N") %>% 
  addLegend(data = may_data, title = 'January N Isotopic', pal = pal_may,
            position = "bottomright", 
            values = ~var1.pred, opacity = 1, group = "January N Isotopic") %>% 
  addLegend(data = may_data, title = 'May N Isotopic', pal = pal_may,
            position = "bottomright", 
            values = ~var1.pred, opacity = 1, group = "May N Isotopic") %>% 
  addLegend(data = may_data, title = 'July N Isotopic', pal = pal_may,
            position = "bottomright", 
            values = ~var1.pred, opacity = 1, group = "July N Isotopic")

#saveWidget(leaf, file = here("leaf.html"))
```

