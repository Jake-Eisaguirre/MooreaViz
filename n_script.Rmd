---
title: "mooreaviz"
author: "Jake Eisaguirre"
date: "1/18/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(here)
library(tidyverse)
library(janitor)
library(raster)
library(viridis)
library(sf)
library(gstat)
library(terra)
library(pracma)
library(sp)
```

```{r}
n_data <- read_csv(here("knb-lter-mcr.5038.10", "MCR_LTER_Adam_EcolAp_N_summary_20200331.csv")) %>% 
  na.omit() %>% 
  clean_names()

nut_bound <- read_csv(here("knb-lter-mcr.5038.10", "MCR_LTER_Adam_EcolAp_Nut_boundary_20200331.csv")) %>% 
  as.data.frame()


  
```

```{r}
#moorea crs EPSG:2976 Need to check with Tom what they want
crs <- 2976

jan_n_data <- n_data %>% 
  dplyr::select(longitude, latitude, percent_n_jan)


#data plot
ggplot() +
  geom_point(data = jan_n_data, mapping = aes(x = longitude, y = latitude, color = percent_n_jan),
             size = 3) + 
  scale_color_viridis(option = "B") +
  theme_classic()


#this boundary is normal lat long
bound_explore <- nut_bound %>% 
  st_as_sf(coords = c("X", "Y"), crs = crs) %>%
  summarise(geometry = st_combine(geometry)) %>% 
  st_cast("POLYGON") %>% 
  mutate(geometry = st_transform(geometry, "+proj=longlat +ellps=WGS84 +datum=WGS84"))

#code to save shape file. once we determine best shape file, current one is wrong. might be better to get shape file of moorea
#and use that for inner bound and then use current outter bound.
shp_bound <- st_write(bound_explore, here("shape_files", "bound.shp"), delete_dsn=TRUE)

bound_explore <- read_sf(here("shape_files", "bound.shp")) %>% 
   mutate(geometry = st_transform(geometry, "+proj=longlat +ellps=WGS84 +datum=WGS84")) %>% 
  st_set_crs(crs)


#reef bound and data point plot
ggplot()+
  geom_sf(data = bound_explore, col = "black", fill = NA) +
  theme_classic() +
  geom_point(data = jan_n_data, mapping = aes(x = longitude, y = latitude, color = percent_n_jan),
             size = 3) + 
  scale_color_viridis(option = "B") +
  coord_sf(crs = crs)



#toms method of krigging that i could not get to work
borderpolygon <- list(data.frame(nut_bound[,1], nut_bound[,2]))

j_data <- data.matrix(jan_n_data)

krig1 <- kriging(j_data[,'longitude'], j_data[,'latitude'], j_data[,'percent_n_jan'], pixels = 1000, polygons = borderpolygon)


```
# Attempt at kriggin. Close but I think the nut_bound is not working properly.
```{r}
#converting jan data to sf and changing lat long to UTM/weird lat long
sf_jan_n_data <- st_as_sf(jan_n_data, coords = c('longitude', 'latitude'), crs = 4326) %>% 
  cbind(st_coordinates(.)) %>% 
  mutate(geometry = st_transform(geometry, 
                                 "+proj=utm +zone=6 +south +ellps=intl +towgs84=162,117,154,0,0,0,0 +units=m +no_defs", 
                                 crs = crs))
#reef bound in UTM/weird lat long
bound <- nut_bound %>% 
  st_as_sf(coords = c("X", "Y"), crs = 4326) %>% 
  summarise(geometry = st_combine(geometry)) %>% 
  st_cast("POLYGON") %>% 
  st_set_crs(crs)

#Island Bound in UTM/weird lat long
island_bound_shp <- read_sf(here("stanford-bh400kc3500-shapefile", "bh400kc3500.shp")) %>% 
  mutate(geometry = st_transform(geometry, 
                                 "+proj=utm +zone=6 +south +ellps=intl 
                                 +towgs84=162,117,154,0,0,0,0 +units=m +no_defs", 
                                 crs = crs)) %>% 
  dplyr::select(geometry)


island_bound <- st_crop(island_bound_shp, bound)
  
plot(island_bound)

#vario gram stuff
jan_n_vario <- gstat::variogram(
  percent_n_jan~1,
  as(sf_jan_n_data, "Spatial"))

plot(jan_n_vario)

v_mod_full <- automap::autofitVariogram(percent_n_jan~1, as(sf_jan_n_data, "Spatial"))

v_mod <- v_mod_full$var_model

#this shape of the plot concerns me
plot(v_mod_full)



#making a gridded box with the bounds of the lat long in UTM/weird lat long
grd_100_sf <- sf_jan_n_data %>% 
  st_bbox() %>% # gets the bbox of our observations
  st_as_sfc() %>% # make the bbox an sfc object
  st_make_grid( # make the grid
  cellsize = c(100, 100), # 100m pixel size
  what = "centers"
  ) %>%
  st_as_sf() %>% # get back to sf object from sfc
  cbind(., st_coordinates(.)) 



#Clipping the gridded box by the reef bound
bound_grid <- st_intersection(grd_100_sf, bound)

#Clipping the gridded reef box with the island
bound_grid <- st_crop(island_bound, bound_grid)

plot(bound_grid)

#Thank you Tamma, converting between formats
grd_100_sp <- as(bound_grid, "Spatial") # converting to {sp} format
gridded(grd_100_sp) <- TRUE             # informing the object that it is a grid
grd_100_sp <- as(grd_100_sp, "SpatialPixels")




OK <- krige(
  percent_n_jan~1,                       # Z is our variable and "~1" means "depends on mean"
  as(sf_jan_n_data, "Spatial"), # input data in {sp} format
  grd_100_sp,                # locations to interpolate at
  model = v_mod # model fitted above !!! <---- Since the model is fitted by variogram and Tom did not do that, maybe we right
  )

plot(OK)
 # a simple `plot(raster(OK))` also works just fine
```

